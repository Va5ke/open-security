# Access Control

## O klasi

Napadi klase Access Control karakterišu se pristupom funkcionalnostima koje nisu namenjene za ulogu datog korisnika. Ovi napadi se javljuju u sistemima sa rupama u logici za autorizaciju, gde maliciozni korisnici zaobilaze predviđene dozvole i tako dolaze do neautorizovanih privilegija.

## Uticaji exploit-ovanja

- Neautorizovan pristup podacima, kao i njihovo modifikovanje i brisanje
- Obavljanje radnji predviđenih za druge korisnike
- Pristup zaštićenim API-jima, datotekama i funkcijama sistema
- Zaobilaženje plaćanja i licenciranja
- Kompromitovan integritet i poverljivost sistema

## Ranjivosti koje omogućuju napad

- Nedostajuća provera nakon autentikacije
- IDOR (Insecure direct object references) - ID-jevi su dostupni bez provere da li je korisnik autorizovan da ih koristi
- Nevalidirane URL adrese koje maliciozni korisnici mogu da pogode i ručno im pristupe
- Kontrola pristupa samo u UI elementima na strani klijenta i njen nedostatak na serverskoj strani

## Kontramere

- Obezbediti autorizaciju na serverskoj strani za svaki zahtev
- Deny-by-default politika sa eksplicitnim davanjem dozvola
- RBAC/ABAC
- Izbegavanje otkrivanja predvidljivih ID-jeva, korišćenje UUID-jeva
- Logovanje svih neuspelih kontrola pristupa radi istrage

# Access Control Labs

## Lab 1 - Unprotected admin functionality (Apprentice)

Dodavanjem /robots.txt na kraj URL-a dolazi se do robots.txt fajla. U njemu je skrivena putanja do administratorskog panela.

![alt text](AC-lab1-1.png)

Dodavanjem /administrator-panel na kraj URL-a dolazi se do administratorskog panela.

![alt text](AC-lab1-2.png)

Klikom na Delete dugme pored carlosovog imena zadatak je rešen.

## Lab 2 - User role controlled by request parameter (Apprentice)

Administratorski panel je blokiran za sve korisnike koji nemaju ulogu administratora.

![alt text](AC-lab2-1.png)

Ukoliko se ulogujemo kao redovni korisnik, pod Network na developer settings nalazimo Cookie koji sadrži informaciju o tome da li korisnik ima ulogu administratora.

![alt text](AC-lab2-2.png)

Pod Application moguće je promeniti vrednosti svih trenutnih kukija na brauzeru, uključujući i polje Admin.

![alt text](AC-lab2-3.png)

Promenom polja na true dobijamo pristup administratorskom panelu.

![alt text](AC-lab2-4.png)

Klikom na Delete dugme pored carlosovog imena zadatak je rešen.

## Lab 3 - URL-based access control can be circumvented (Practitioner)

Administratorski panel je blokiran za sve korisnike koji nemaju ulogu administratora.

![alt text](AC-lab3-1.png)

Intercept-ovanjem zahteva preko Burp Suite alata nam omogućuje da ga čitamo.

![alt text](AC-lab3-2.png)

Administratorskom panelu se sada može pristupiti odavanjem X-Original-URL headera i menjanjem URL-a pre nego što se zahtev pošalje.

![alt text](AC-lab3-3.png)

![alt text](AC-lab3-4.png)

Klikom na Delete dugme pored carlosovog imena zadatak je rešen.

## Lab 4 - Method-based access control can be circumvented (Practitioner)

Ukoliko se ulogujemo kao administrator, dobijamo mogućnost menjanja uloga svih korisnika. Preko Burp Suite Interceptor-a za operaciju Upgrade i korisnika sa imenom carlos dobijamo sledeći izgled zahteva.

![alt text](AC-lab4-1.png)

Ukoliko pokušamo da pošaljemo isti zahtev dok smo ulogovani kao redovni korisnik (kopiranjem session kukija sa drugog brauzera i lepljenjem ga na Cookie header u zahtevu), sistem nas obaveštava da taj korisnik nije autorizovan za akciju menjanja uloge.

![alt text](AC-lab4-2.png)

![alt text](AC-lab4-3.png)

Međutim, menjanjem metode na GET, akcija je omogućena i sa kukijem redovnog korisnika.

![alt text](AC-lab4-4.png)

Slanjem tako izmenjenog zahteva (sa korisničkim imenom wiener) zadatak je rešen.

## Lab 5 - Multi-step process with no access control on one step (Practitioner)

Ukoliko se ulogujemo kao administrator, dobijamo mogućnost menjanja uloga svih korisnika. Preko Burp Suite Interceptor-a za konfirmaciju posle operacije Upgrade i korisnika sa imenom carlos dobijamo sledeći izgled zahteva.

![alt text](AC-lab5-1.png)

Ukoliko pokušamo da pošaljemo isti zahtev dok smo ulogovani kao redovni korisnik (kopiranjem session kukija sa drugog brauzera i lepljenjem ga na Cookie header u zahtevu), sistem nam dozvoljava. Provera autorizacije nije prikladno podešena za poslednji zahtev koji se šalje pri akciji menjanja uloge korisnika.

![alt text](AC-lab5-2.png)

![alt text](AC-lab5-3.png)

Slanjem tako izmenjenog zahteva (sa korisničkim imenom wiener) zadatak je rešen.

# CORS

## O klasi

CORS (Cross Origin Resource Sharing) je bezbednosni mehanizam na brauzeru koji kontroliše koji eksterni domeni mogu da vrše interakciju sa resursima veb-aplikacije preko JavaScript-a. Ukoliko je loše podešen, maliciozni sajtovi mogu da šalju autentikovane zahteve ka meti i pristupe osetljivim podacima sa njenog brauzera.

## Uticaji exploit-ovanja

- Krađa osetljivih podataka: ličnih informacija, tokena, podataka sa platne karticež
- Preuzimanje naloga krađom sesije
- Neautorizovano slanje autentikovanih zahteva u ime žrtve
- Pristup unutrašnjim API-jima ili resursima koji su obično ograničeni poverljivim Origin-ima

## Ranjivosti koje omogućuju napad

- Previše opšte definisan Access-Control-Allow-Origin header, npr. "*" (propušta svaki Origin)
- Upisivanje nepoverljivih izvora u CORS belu listu
- Stavljanje Access-Control-Allow-Credentials header-a na true
- Zaobilaženje validacije Origin header-a pre odgovora

## Kontramere

- Eksplicitna definicija liste dozvoljenih Origin-ova
- Ukoliko je Access-Control-Allow-Credentials omogućeno, Access-Control-Allow-Origin ne sme biti "*"
- Validacija Origin header-a na serverskoj strani pre odgovora
- Limitacija dozvoljenih HTTP metoda i header-a u CORS konfiguraciji
- Redovno logovanje CORS podešavanja za spoljne programe i API-je (u slučaju neprimetnog menjanja podešavanja u third-party servisima)

# CORS Labs

## Lab 1 - CORS vulnerability with basic origin reflection (Apprentice)

Propuštanjem login funkcionalnosti kroz Burp Suite Interceptor primećeno je da je korisnikov API ključ dobavljen na endpoint-u "/accountDetails". U odgovoru se pojavljuje header Access-Control-Allow-Credentials: true, što nagoveštava da je CORS podržan.

![alt text](CORS-lab1-1.png)

Kopiranjem zahteva na Burp Suit Repeater i slanjem istog sa dodatim Origin headerom i nasumičnom adresom, uočićemo da je vraća u odgovoru.

![alt text](CORS-lab1-2.png)

Sledi zaključak da je CORS podešen tako da prihvata bilo koji Origin.

Na exploit serveru potrebno je ukucati sledeći kod u telo zahteva kako bi se izvršio napad na administratorov brauzer.

![alt text](CORS-lab1-3.png)

Dostavljanjem exploit-a žrtvi i pristupanjem u access log pronađen je API ključ administratora kao jedno od polja iz odgovora.

![alt text](CORS-lab1-4.png)

Zadatak je rešen unosom administratorovog API ključa.

## Lab 2 - CORS vulnerability with trusted null origin (Apprentice)

Propuštanjem login funkcionalnosti kroz Burp Suite Interceptor primećeno je da je korisnikov API ključ dobavljen na endpoint-u "/accountDetails". U odgovoru se pojavljuje header Access-Control-Allow-Credentials: true, što nagoveštava da je CORS podržan.

![alt text](CORS-lab2-1.png)

Kopiranjem zahteva na Burp Suit Repeater i slanjem istog sa dodatim Origin headerom i vrednošću null, uočićemo da je vraća u odgovoru.

![alt text](CORS-lab2-2.png)

Sledi zaključak da je CORS podešen tako da prihvata null Origin.

Na exploit serveru potrebno je ukucati sledeći kod u telo zahteva kako bi se izvršio napad na administratorov brauzer. iframe sandbox šalje zahtev sa null Origin-a.

![alt text](CORS-lab2-3.png)

Dostavljanjem exploit-a žrtvi i pristupanjem u access log pronađen je API ključ administratora kao jedno od polja iz odgovora.

![alt text](CORS-lab2-4.png)

Zadatak je rešen unosom administratorovog API ključa.

## Lab 3 - CORS vulnerability with trusted insecure protocols (Practitioner)

Propuštanjem login funkcionalnosti kroz Burp Suite Interceptor primećeno je da je korisnikov API ključ dobavljen na endpoint-u "/accountDetails". U odgovoru se pojavljuje header Access-Control-Allow-Credentials: true, što nagoveštava da je CORS podržan.

![alt text](CORS-lab3-1.png)

Kopiranjem zahteva na Burp Suit Repeater i slanjem istog sa dodatim Origin headerom i adresom koja se završava URL-om zadatka, uočićemo da je vraća u odgovoru.

![alt text](CORS-lab3-2.png)

Sledi zaključak da je CORS podešen tako da za Origin prihvata bilo koji poddomen koji se završava host domenom. Jedan zahtev čiji URL zadovoljava ovaj format se nalazi u funkcionalnosti Check Stock za bilo koji proizvod. Moguće je nakačiti maliciozni kod na njegov otkriven parametar productID.

![alt text](CORS-lab3-3.png)

Na exploit serveru potrebno je ukucati sledeći kod u telo zahteva kako bi se izvršio napad na administratorov brauzer.

![alt text](CORS-lab3-4.png)

Dostavljanjem exploit-a žrtvi i pristupanjem u access log pronađen je API ključ administratora kao jedno od polja iz odgovora.

![alt text](CORS-lab3-5.png)

Zadatak je rešen unosom administratorovog API ključa.

#

Dva preostala zadatka težine Practitioner urađena su u oblasti Clickjacking.
